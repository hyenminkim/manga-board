<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>채팅방</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<th:block th:insert="~{common/header::header}"></th:block>
<div id="msgArea"></div>
<input type="text" id="msg"><button onclick="send()">전송</button>



<script th:if="${err}">
    alert("해당 채팅방은 삭제되었거나 없습니다.");
    location.href = '/chat/list';
</script>



<script th:inline="javascript">
    let roomId = [[${room_id}]];
    let username = [[${username}]];
    const socket = new WebSocket("ws://localhost:8080/ws/chat");

    socket.onopen = function () {
        const joinMessage = {
            messageType: "JOIN",
            chatRoomId: roomId,
            sender: username,
            message: username + " 님이 입장하셨습니다."
        };
        socket.send(JSON.stringify(joinMessage));
    };

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        $("#msgArea").append(`<p><b>${data.sender}</b>: ${data.message}</p>`);
    };

    window.addEventListener("beforeunload", function () {
        const leaveMessage = {
            messageType: "LEAVE",
            chatRoomId: roomId,
            sender: username,
            message: username + " 님이 퇴장하셨습니다."
        };
        socket.send(JSON.stringify(leaveMessage));
    });

    function send() {
        const msg = $("#msg").val();
        const chatMessage = {
            messageType: "TALK",
            chatRoomId: roomId,
            sender: username,
            message: msg
        };
        socket.send(JSON.stringify(chatMessage));
        $("#msg").val('');
    }
</script>
</body>
</html>
